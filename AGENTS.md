# AGENTS.md: 開発者（AIエージェント）のためのメモ

このファイルは、AIエージェントである私がこのリポジトリで効率的に作業を進めるためのメモです。
内容は私の理解に合わせて自由に更新、追記、整理することが推奨されています。少しでも気になったことや、次に作業するエージェントの助けになりそうなことがあれば、気兼ねなく積極的に追記・更新してください。

---

## 1. 開発環境のセットアップ

このリポジトリのRubyスクリプトを実行するための環境を構築します。

### 手順

以下のコマンドを一度だけ実行してください。

```bash
bash script/setup_environment.sh
```

このスクリプトは、rbenv、Ruby、Bundlerなど、必要なツールやライブラリのインストールを自動的に行います。詳細はスクリプトの中身を確認してください。

### 実行後

スクリプトの実行が完了したら、**シェルを再起動する**か、以下のコマンドを実行してシェルの設定を再読み込みしてください。

```bash
source ~/.bashrc
```

---

## 2. スクリプトの実行

スクリプトを実行する際の基本的なコマンドは以下の通りです。

```bash
KARMA_ENV=jules bundle exec ruby script/kaiteki.rb
```

**注意:**
- `script/kaiteki.rb` の部分は、実行したいスクリプトのパスに置き換えてください。
- `-Ilib` オプションは `bundle exec` を使うことで不要になる場合がありますが、もしライブラリの読み込みで問題が発生した場合は、`bundle exec ruby -Ilib ...` のように試してください。

---

## 3. テストの実行

このプロジェクトはRSpecでテストされています。テストスイート全体を実行するには、次のコマンドを使用します。

```bash
bundle exec rspec
```

---

## 4. アプリケーションメモ

### `kaiteki` 機能

`kaiteki`は、室内の温度・湿度を元に、エアコンを自動制御して快適な環境を維持する機能です。

#### アーキテクチャ

責務ごとにクラスが分割されています。

- **`Kaiteki` (`app/kaiteki.rb`)**
  - **役割:** オーケストレーター（司令塔）
  - 他のサービスクラスを協調させ、快適な環境を維持するための主要なビジネスロジックを実行します。

- **`Kaiteki::MetricsRepository` (`lib/kaiteki/metrics_repository.rb`)**
  - **役割:** データ永続化
  - Ambient APIと通信し、メトリクス（温度、湿度、設定温度など）の保存と読み込みを担当します。

- **`Kaiteki::Meter` (`lib/kaiteki/meter.rb`)**
  - **役割:** 現在のメトリクス取得
  - SwitchBotの温度計（Meter）から、現在の温度・湿度を読み取ります。

- **`Kaiteki::AirConditioner` (`lib/kaiteki/air_conditioner.rb`)**
  - **役割:** エアコン操作
  - SwitchBotのスマートプラグと赤外線リモコンを操作し、エアコンの電源状態の確認や温度設定を行います。

#### 実行とテスト

- **実行スクリプト:** `script/kaiteki.rb` がこの機能のエントリーポイントです。
- **テスト:** 各クラスには対応する単体テストが `spec/lib/kaiteki/` 配下に存在します。`spec/app/kaiteki_spec.rb` は、`Kaiteki`クラスの協調動作をテストします。

---

## 5. コーディング規約

### コメント言語

- コード内のコメントや、テストの`context`/`it`ブロックの説明文は、原則として**日本語で記述**してください。
- これにより、プロジェクトのコンテキストを理解しやすくなり、開発者間のコミュニケーションが円滑になります。

---

## 6. 一般的な開発フロー

このリポジトリで開発を行う際の基本的な流れです。

1. **環境構築**: `script/setup_environment.sh` を実行します（初回のみ）。
2. **計画立案**: ユーザーの要求を理解し、コードを調査した上で、`set_plan`ツールを使って具体的な作業計画を立てます。
3. **実装**: 計画に従って、機能の実装やリファクタリングを行います。
4. **テスト実行**: `bundle exec rspec` を実行し、全てのテストがパスすることを確認します。必要に応じて新しいテストも追加します。
5. **レビュー**: `request_code_review` ツールを使って、変更内容のレビューを依頼します。
6. **ドキュメント更新**: `AGENTS.md`など、関連するドキュメントに変更内容を反映させます。
7. **提出**: `submit` ツールを使って、変更を提出します。
